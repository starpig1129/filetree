{% extends "base.html" %} {% block title %}{{ user.username }} 的臨時樹屋{%
endblock %} {% block content %}
<div id="root"></div>

<script>
  window.__PAGE__ = 'user';
  window.__INITIAL_DATA__ = {
      user: {{ user | tojson if user else {} }},
      usage: {{ usage | tojson if usage else 0 }},
      files: {{ files | tojson if files else [] }},
      urls: {{ urls | tojson if urls else [] }}
  };
</script>
{% endblock %} {% endblock %} {% block extra_scripts %}
<script>
  const username = "{{ user.username }}";
  let isLocked = false;

  // 修改後的寫法：先檢查是否存在，不存在再宣告
  window.Toast =
    window.Toast ||
    Swal.mixin({
      toast: true,
      position: "top-end",
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
    });

  // 頁面載入時檢查鎖定狀態
  document.addEventListener("DOMContentLoaded", function () {
    fetch(`/api/check_lock/${username}`)
      .then((response) => response.json())
      .then((data) => {
        isLocked = data.isLocked;
        updateLockIcon();
      });
  });

  function updateLockIcon() {
    const lockIcon = document.getElementById("lockIcon");
    lockIcon.className = isLocked ? "fas fa-lock" : "fas fa-unlock";
  }

  function toggleLock() {
    if (isLocked) {
      // 解鎖
      fetch(`/api/unlock/${username}`, { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            isLocked = false;
            updateLockIcon();
            Toast.fire({ icon: "success", title: "樹屋已解鎖" });
          }
        });
    } else {
      // 上鎖
      Swal.fire({
        title: "請輸入密碼進行上鎖",
        input: "password",
        inputPlaceholder: "輸入密碼",
        showCancelButton: true,
        confirmButtonText: "上鎖",
        cancelButtonText: "取消",
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/lock/${username}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: result.value }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                isLocked = true;
                updateLockIcon();
                Toast.fire({ icon: "success", title: "樹屋已上鎖" });
              } else {
                Swal.fire("錯誤", data.message, "error");
              }
            });
        }
      });
    }
  }

  function deleteFile(filename) {
    Swal.fire({
      title: "確定要刪除嗎？",
      text: `檔案 "${filename}" 將被永久刪除`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc3545",
      confirmButtonText: "刪除",
      cancelButtonText: "取消",
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/delete/${username}/${encodeURIComponent(filename)}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Toast.fire({ icon: "success", title: "檔案已刪除" });
              document
                .querySelector(`tr[data-filename="${filename}"]`)
                .remove();
            } else {
              Swal.fire("錯誤", data.message, "error");
            }
          });
      }
    });
  }

  function shareFile(filename) {
    // 調用後端 API 生成有時效性的分享連結
    fetch(`/api/share/${username}/${encodeURIComponent(filename)}`, {
      method: "POST",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          Swal.fire({
            title: "分享連結已生成",
            html: `
                            <div class="text-start">
                                <p class="mb-2"><strong>分享連結：</strong></p>
                                <input type="text" class="form-control mb-3" value="${data.share_url}" id="shareUrlInput" readonly>
                                
                                <div class="text-center mb-3">
                                    <p class="mb-2"><strong><i class="fas fa-qrcode me-1"></i>QR Code 掃描下載：</strong></p>
                                    <div id="qrcodeContainer" style="display: flex; justify-content: center;">
                                        <canvas id="qrcodeCanvas"></canvas>
                                    </div>
                                </div>
                                
                                <p class="text-muted small">
                                    <i class="fas fa-clock me-1"></i>
                                    有效期限：${data.expiry_hours} 小時<br>
                                    <i class="fas fa-calendar me-1"></i>
                                    到期時間：${data.expiry}
                                </p>
                            </div>
                        `,
            showCancelButton: true,
            confirmButtonText: "複製連結",
            cancelButtonText: "關閉",
            didOpen: () => {
              document.getElementById("shareUrlInput").select();
              // 生成 QR Code
              const container = document.getElementById("qrcodeContainer");
              container.innerHTML = ""; // 清空舊的 QR Code

              try {
                new QRCode(container, {
                  text: data.share_url,
                  width: 200,
                  height: 200,
                  colorDark: "#2d5a27",
                  colorLight: "#ffffff",
                  correctLevel: QRCode.CorrectLevel.H,
                });
              } catch (e) {
                console.error("QR Code 生成失敗:", e);
                container.innerHTML =
                  '<p class="text-danger">QR Code 生成失敗</p>';
              }
            },
          }).then((result) => {
            if (result.isConfirmed) {
              navigator.clipboard.writeText(data.share_url).then(() => {
                Toast.fire({ icon: "success", title: "連結已複製到剪貼簿" });
              });
            }
          });
        } else {
          Swal.fire("錯誤", data.message, "error");
        }
      })
      .catch((error) => {
        console.error("分享失敗:", error);
        Swal.fire("錯誤", "無法生成分享連結，請稍後再試", "error");
      });
  }

  function copyUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
      Toast.fire({ icon: "success", title: "網址已複製" });
    });
  }

  function deleteUrl(url) {
    Swal.fire({
      title: "確定要刪除嗎？",
      text: "此網址記錄將被刪除",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc3545",
      confirmButtonText: "刪除",
      cancelButtonText: "取消",
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/delete_url/${username}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: url }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Toast.fire({ icon: "success", title: "網址已刪除" });
              document.querySelector(`tr[data-url="${url}"]`).remove();
            }
          });
      }
    });
  }

  // 批次操作
  function toggleSelectAll() {
    const checkboxes = document.querySelectorAll(".file-checkbox");
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    checkboxes.forEach((cb) => (cb.checked = selectAllCheckbox.checked));
    updateBatchButtons();
  }

  function updateBatchButtons() {
    const checkboxes = document.querySelectorAll(".file-checkbox:checked");
    const count = checkboxes.length;

    document.getElementById("selectedCount").textContent =
      `已選擇 ${count} 個檔案`;
    document.getElementById("batchDeleteBtn").disabled = count === 0;
    document.getElementById("batchDownloadBtn").disabled = count === 0;
  }

  function batchDelete() {
    const checkboxes = document.querySelectorAll(".file-checkbox:checked");
    const files = Array.from(checkboxes).map((cb) => cb.value);

    Swal.fire({
      title: "確定要批次刪除嗎？",
      text: `將刪除 ${files.length} 個檔案`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc3545",
      confirmButtonText: "刪除全部",
      cancelButtonText: "取消",
    }).then((result) => {
      if (result.isConfirmed) {
        Promise.all(
          files.map((filename) =>
            fetch(`/api/delete/${username}/${encodeURIComponent(filename)}`, {
              method: "DELETE",
            }),
          ),
        ).then(() => {
          Toast.fire({ icon: "success", title: "批次刪除完成" });
          location.reload();
        });
      }
    });
  }

  function batchDownload() {
    const checkboxes = document.querySelectorAll(".file-checkbox:checked");
    checkboxes.forEach((cb) => {
      const filename = cb.value;
      const link = document.createElement("a");
      link.href = `/uploads/${username}/${encodeURIComponent(filename)}`;
      link.download = filename;
      link.click();
    });
  }
</script>
{% endblock %}
